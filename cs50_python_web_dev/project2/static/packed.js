const selectors={newChannelModal:$("#newChannelModal"),newChannelModalForm:$("#newChannelModalForm"),newChannelModalButton:$("#newChannelModalButton"),newChannelModalTextField:$("#newChannelModalTextField"),displayNameModal:$("#displayNameModal"),displayNameModalForm:$("#displayNameModalForm"),displayNameModalButton:$("#displayNameModalButton"),displayNameModalTextField:$("#displayNameModalTextField"),channelList:$("#channelList"),userList:$("#userList"),channelNameHeader:$("#channelNameHeader"),channelAlreadyExistsAlert:$("#channelAlreadyExistsAlert"),messageThreadContainer:$("#messageThreadContainer"),messageThread:$("#messageThread"),messageComposerForm:$("#messageComposerForm"),messageComposerTextArea:$("#messageComposerTextArea")};let channels=[];let users=[];let socket=null;let currentChannelId=null;let currentChannelMessages=null;let currentUserId=null;let channelListTemplate=Handlebars.compile(document.getElementById("channelListTemplate").innerHTML);let userListTemplate=Handlebars.compile(document.getElementById("userListTemplate").innerHTML);let messageThreadTemplate=Handlebars.compile(document.getElementById("messageThreadTemplate").innerHTML);$(document).ready(()=>{selectors.displayNameModalButton.click(()=>{selectors.displayNameModal.modal('show');});selectors.displayNameModalForm.submit((event)=>{const isValid=checkHTMLFormValidation(event,selectors.displayNameModalForm[0],selectors.displayNameModalTextField);if(isValid){createOrChangeDisplayName(selectors.displayNameModalTextField.val());}});selectors.newChannelModalButton.click(()=>{selectors.channelAlreadyExistsAlert.hide();selectors.newChannelModal.modal('show');});selectors.newChannelModalForm.submit((event)=>{const isValid=checkHTMLFormValidation(event,selectors.newChannelModalForm[0],selectors.newChannelModalTextField);if(isValid){createChannel(selectors.newChannelModalTextField.val());selectors.newChannelModalTextField.val("");}});selectors.messageComposerForm.submit((event)=>{const isValid=checkHTMLFormValidation(event,selectors.messageComposerForm[0],selectors.messageComposerTextArea);if(isValid){sendMessage(selectors.messageComposerTextArea.val());selectors.messageComposerTextArea.val("");}});load_user();init_socketio();});function load_user(){const localStorageCurrentUserId=localStorage.getItem("currentUserId");const request=new XMLHttpRequest();request.open('GET',`/users`);request.onload=()=>{const allAppUsers=JSON.parse(request.responseText);if(localStorageCurrentUserId&&(allAppUsers.find((user)=>user.id===localStorageCurrentUserId))){currentUserId=localStorageCurrentUserId;selectors.displayNameModalTextField.val(allAppUsers.find((user)=>user.id===localStorageCurrentUserId).displayName);selectors.displayNameModal.modal('hide');}else{selectors.displayNameModal.modal('show');}};request.setRequestHeader("Content-Type","application/json;charset=UTF-8");request.send();}
function createChannel(channelName){const request=new XMLHttpRequest();request.open('POST',`/channels`);request.onreadystatechange=()=>{if(request.readyState===4){if(request.status===200){selectors.channelAlreadyExistsAlert.hide();selectors.newChannelModal.modal('hide');}else if(request.status===409){selectors.channelAlreadyExistsAlert.show();}}};request.setRequestHeader("Content-Type","application/json;charset=UTF-8");request.send(JSON.stringify({name:channelName,timestamp:Date.now()}));}
function selectChannel(channelId){currentChannelId=channelId;const channel=channels.find((channel)=>channel.id===currentChannelId);selectors.channelNameHeader.html(channel.name);document.title='Flak App | '+channel.name;history.pushState({},document.title,`/chat/${channelId}`);const request=new XMLHttpRequest();request.open('GET',`/channels/${currentChannelId}/messages`);request.onload=()=>{currentChannelMessages=JSON.parse(request.responseText).messages;selectors.messageThread.html(messageThreadTemplate(currentChannelMessages));};request.setRequestHeader("Content-Type","application/json;charset=UTF-8");request.send();}
function createOrChangeDisplayName(displayName){requestMethod=currentUserId?'PUT':'POST';endpoint=currentUserId?`/users/${currentUserId}`:'/users';const request=new XMLHttpRequest();request.open(requestMethod,endpoint);request.onload=()=>{localStorage.setItem("currentUserId",JSON.parse(request.responseText).id);load_user();};request.setRequestHeader("Content-Type","application/json;charset=UTF-8");request.send(JSON.stringify({displayName:displayName}));}
function init_socketio(){socket=io();socket.on('chat_message',(message)=>{receiveMessage(message)});socket.on('channel_update',(response)=>{updateChannels(response.channels);});socket.on('users_update',(response)=>{updateUsers(response.users);});}
function updateUsers(updatedUsers){users=updatedUsers;selectors.userList.html(userListTemplate(users));selectors.messageThread.html(messageThreadTemplate(currentChannelMessages));}
function updateChannels(updatedChannels){channels=updatedChannels;selectors.channelList.html(channelListTemplate(channels));if(!currentChannelId){selectChannel(channels[0].id);}}
function sendMessage(message){socket.emit('chat_message',currentChannelId,currentUserId,Date.now(),message);}
function receiveMessage(message){if(message.channel===currentChannelId){if(currentChannelMessages.length>=100){currentChannelMessages.shift()}
currentChannelMessages.push(message);selectors.messageThread.html(messageThreadTemplate(currentChannelMessages));selectors.messageThreadContainer.scrollTop(selectors.messageThreadContainer.height());}}
function checkHTMLFormValidation(event,formElement,textInputElement){event.preventDefault();if(formElement.checkValidity()){return true;}else{alert(textInputElement.validationMessage);return false;}}
Handlebars.registerHelper("prettifyDate",function(timestamp){return(new Date(timestamp).toLocaleDateString()+' '+new Date(timestamp).toLocaleTimeString());});Handlebars.registerHelper("getUserDisplayNameById",function(userId){return(users.find((user)=>user.id===userId).displayName);});Handlebars.registerHelper('if_current_user',function(senderId){if(currentUserId===senderId){return'text-right';}
return null;});